# å¹¶å‘æ§åˆ¶å™¨

<div class="tip custom-block">

è§†é¢‘è®²è§£

* [æŠ–éŸ³](https://www.douyin.com/user/self?from_tab_name=main&modal_id=7416331503614954761&showTab=post)
* [å“”å“©å“”å“©](https://www.bilibili.com/video/BV1K7tXenEwG/?spm_id_from=333.1387.search.video_card.click)

</div>

## 1. é—®é¢˜åœºæ™¯

å‡è®¾æˆ‘ä»¬è¦ä¸Šä¼ ä¸€ä¸ª 20GB çš„å¤§æ–‡ä»¶ï¼Œå°†å…¶åˆ†æˆ 100 ä¸ª 10MB çš„åˆ†ç‰‡ã€‚å¦‚æœä¸ä½¿ç”¨ä»»åŠ¡è°ƒåº¦å™¨ï¼ŒåŒæ—¶å‘èµ· 100 ä¸ªä¸Šä¼ è¯·æ±‚ä¼šå¯¼è‡´ä»¥ä¸‹é—®é¢˜ï¼š

1. **æµè§ˆå™¨çš„å¹¶å‘è¯·æ±‚æ•°é‡è¢«å æ»¡** - æµè§ˆå™¨å¯¹åŒä¸€åŸŸåçš„å¹¶å‘è¯·æ±‚æœ‰é™åˆ¶ï¼ˆé€šå¸¸ä¸º 6-8 ä¸ªï¼‰
2. **å…¶ä»–æ­£å¸¸ä¸šåŠ¡è¯·æ±‚å¯èƒ½æ— æ³•åŠæ—¶å‘é€** - æ‰€æœ‰è¿æ¥è¢«æ–‡ä»¶ä¸Šä¼ å ç”¨
3. **æœåŠ¡å™¨å‹åŠ›è¿‡å¤§** - åŒæ—¶å¤„ç†å¤§é‡è¯·æ±‚å¯èƒ½å¯¼è‡´æœåŠ¡å™¨å“åº”ç¼“æ…¢æˆ–å´©æºƒ
4. **ç½‘ç»œå¸¦å®½è¢«å æ»¡** - å¤§é‡å¹¶å‘ä¸Šä¼ ä¼šæ¶ˆè€—æ‰€æœ‰å¯ç”¨å¸¦å®½

## 2. è§£å†³æ–¹æ¡ˆ

æˆ‘ä»¬å¯ä»¥å°è¯•ç€å°†æ‰€æœ‰çš„ä»»åŠ¡ï¼Œéƒ½æ”¾åˆ°ä¸€ä¸ªé˜Ÿåˆ—é‡Œé¢å»ï¼Œè¿™æ ·æˆ‘ä»¬æ¯æ¬¡æœ€å¤šå‘é€ä¸¤ä¸ªè¯·æ±‚ï¼Œå¦‚æœæœ‰ä¸€ä¸ªè¯·æ±‚å‘é€å®Œæˆï¼Œé‚£ä¹ˆæˆ‘ä»¬å†ä»è¿™ä¸ªé˜Ÿåˆ—é‡Œé¢å–å‡ºä¸€ä¸ªå‘é€è¯·æ±‚ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿è¯åŒæ—¶å‘é€çš„è¯·æ±‚ä¸è¶…è¿‡ä¸¤ä¸ªï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯å¹¶å‘æ•°é‡ä¸è¢«å æ»¡ï¼Œä¹Ÿä¸ä¼šå ç”¨è¿‡å¤šçš„å¸¦å®½ã€‚

## 3. å®ç°åŸç†

å¹¶å‘æ§åˆ¶å™¨çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

- ç»´æŠ¤ä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—
- æ§åˆ¶åŒæ—¶æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡
- å½“æœ‰ä»»åŠ¡å®Œæˆæ—¶ï¼Œè‡ªåŠ¨ä»é˜Ÿåˆ—ä¸­å–å‡ºæ–°ä»»åŠ¡æ‰§è¡Œ

## 4. ä»£ç å®ç°

```javascript
/**
 * ä»»åŠ¡è°ƒåº¦å™¨ç±»
 * ç”¨äºæ§åˆ¶å¹¶å‘ä»»åŠ¡çš„æ‰§è¡Œæ•°é‡
 */
class TaskScheduler {
    tasks = [] // å¾…æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—
    runningCount = 0 // å½“å‰æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡æ•°é‡
    maxRunning = Infinity // æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°é‡

    /**
     * æ„é€ å‡½æ•°
     * @param {number} maxRunning æœ€å¤§å¹¶å‘æ•°ï¼Œé»˜è®¤ä¸ºæ— é™åˆ¶
     */
    constructor(maxRunning = Infinity) {
    // å¦‚æœä¼ å…¥0ï¼Œåˆ™è®¾ä¸ºæ— é™åˆ¶
        this.maxRunning = maxRunning === 0 ? Infinity : maxRunning
    }

    /**
     * æ‰§è¡Œä»»åŠ¡çš„æ ¸å¿ƒæ–¹æ³•
     * æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰§è¡Œæ–°ä»»åŠ¡ï¼Œå¦‚æœå¯ä»¥åˆ™ä»é˜Ÿåˆ—ä¸­å–å‡ºå¹¶æ‰§è¡Œ
     */
    run() {
    // å¦‚æœå½“å‰è¿è¡Œçš„ä»»åŠ¡æ•°å·²è¾¾åˆ°æœ€å¤§å€¼ï¼Œåˆ™ä¸æ‰§è¡Œæ–°ä»»åŠ¡
        if (this.runningCount >= this.maxRunning) {
            return
        }
        // å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™æ— ä»»åŠ¡å¯æ‰§è¡Œ
        if (this.tasks.length === 0) {
            return
        }

        // å¢åŠ è¿è¡Œä¸­ä»»åŠ¡è®¡æ•°
        this.runningCount++
        // ä»é˜Ÿåˆ—å¤´éƒ¨å–å‡ºä¸€ä¸ªä»»åŠ¡
        const task = this.tasks.shift()

        // æ‰§è¡Œä»»åŠ¡ï¼Œæ— è®ºæˆåŠŸæˆ–å¤±è´¥éƒ½ä¼šåœ¨å®Œæˆåé€’å½’è°ƒç”¨runæ–¹æ³•
        task().finally(() => {
            this.runningCount-- // ä»»åŠ¡å®Œæˆï¼Œå‡å°‘è¿è¡Œä¸­ä»»åŠ¡è®¡æ•°
            this.run() // å°è¯•æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡
        })
    }

    /**
     * æ·»åŠ ä»»åŠ¡åˆ°è°ƒåº¦å™¨
     * @param {Function} task è¦æ‰§è¡Œçš„ä»»åŠ¡å‡½æ•°ï¼Œåº”è¿”å›Promise
     * @returns {Promise} è¿”å›Promiseï¼Œåœ¨ä»»åŠ¡å®Œæˆæ—¶resolve
     */
    addTask(task) {
        return new Promise((resolve, reject) => {
            // å°†ä»»åŠ¡åŒ…è£…åæ·»åŠ åˆ°é˜Ÿåˆ—ä¸­
            this.tasks.push(() => task().then(resolve).catch(reject))
            // this.tasks.push(() => task().then(resolve, reject)); // å¦ä¸€ç§å†™æ³•

            // å°è¯•ç«‹å³æ‰§è¡Œä»»åŠ¡
            this.run()
        })
    }
}
```

## 5. ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨

```javascript
// åˆ›å»ºä¸€ä¸ªæœ€å¤§å¹¶å‘æ•°ä¸º2çš„è°ƒåº¦å™¨å®ä¾‹
const scheduler = new TaskScheduler(2)

// è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºå»¶æ—¶Promise
const sleep = time => new Promise(resolve => setTimeout(resolve, time))

// å¼€å§‹è®¡æ—¶
console.time('task1')
console.time('task2')
console.time('task3')
console.time('task4')
console.time('task5')

// æ·»åŠ 5ä¸ªä»»åŠ¡åˆ°è°ƒåº¦å™¨ï¼Œæ¯ä¸ªä»»åŠ¡è€—æ—¶1ç§’
// ç”±äºæœ€å¤§å¹¶å‘æ•°ä¸º2ï¼Œæ‰€ä»¥ä¼šåˆ†æ‰¹æ‰§è¡Œï¼šå‰2ä¸ªå¹¶è¡Œï¼Œå3ä¸ªæ’é˜Ÿ
scheduler.addTask(() => sleep(1000).then(() => console.timeEnd('task1')))
scheduler.addTask(() => sleep(1000).then(() => console.timeEnd('task2')))
scheduler.addTask(() => sleep(1000).then(() => console.timeEnd('task3')))
scheduler.addTask(() => sleep(1000).then(() => console.timeEnd('task4')))
scheduler.addTask(() => sleep(1000).then(() => console.timeEnd('task5')))
```

### æ–‡ä»¶ä¸Šä¼ åœºæ™¯

```javascript
// åˆ›å»ºæ–‡ä»¶ä¸Šä¼ è°ƒåº¦å™¨ï¼Œæœ€å¤§å¹¶å‘æ•°ä¸º3
const uploadScheduler = new TaskScheduler(3)

// æ¨¡æ‹Ÿæ–‡ä»¶åˆ†ç‰‡ä¸Šä¼ 
function uploadChunk(chunkData, chunkIndex) {
    return fetch('/upload', {
        method: 'POST',
        body: chunkData,
        headers: {
            'Content-Type': 'application/octet-stream',
            'X-Chunk-Index': chunkIndex,
        },
    })
}

// ä¸Šä¼ 100ä¸ªåˆ†ç‰‡ï¼Œä½†åŒæ—¶åªæœ‰3ä¸ªåœ¨ä¸Šä¼ 
const chunks = Array.from({ length: 100 }, (_, i) => i)
const uploadPromises = chunks.map((chunkIndex) => {
    return uploadScheduler.addTask(() => {
        console.log(`å¼€å§‹ä¸Šä¼ åˆ†ç‰‡ ${chunkIndex}`)
        return uploadChunk(getChunkData(chunkIndex), chunkIndex).then(() => console.log(`åˆ†ç‰‡ ${chunkIndex} ä¸Šä¼ å®Œæˆ`))
    })
})

// ç­‰å¾…æ‰€æœ‰åˆ†ç‰‡ä¸Šä¼ å®Œæˆ
Promise.all(uploadPromises)
    .then(() => console.log('æ‰€æœ‰åˆ†ç‰‡ä¸Šä¼ å®Œæˆ'))
    .catch(err => console.error('ä¸Šä¼ å¤±è´¥:', err))
```

## 6. æ‰§è¡Œæ•ˆæœ

ä½¿ç”¨å¹¶å‘æ§åˆ¶å™¨åï¼š

- **æ§åˆ¶å¹¶å‘æ•°é‡**ï¼šåŒæ—¶æœ€å¤šåªæœ‰æŒ‡å®šæ•°é‡çš„è¯·æ±‚åœ¨æ‰§è¡Œ
- **è‡ªåŠ¨é˜Ÿåˆ—ç®¡ç†**ï¼šä»»åŠ¡å®Œæˆåè‡ªåŠ¨æ‰§è¡Œä¸‹ä¸€ä¸ªæ’é˜Ÿçš„ä»»åŠ¡
- **èµ„æºåˆç†åˆ©ç”¨**ï¼šé¿å…æµè§ˆå™¨è¿æ¥æ•°é™åˆ¶å’ŒæœåŠ¡å™¨å‹åŠ›è¿‡å¤§
- **å¸¦å®½ä¼˜åŒ–**ï¼šåˆç†åˆ†é…ç½‘ç»œå¸¦å®½ï¼Œä¸å½±å“å…¶ä»–ä¸šåŠ¡è¯·æ±‚

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æœ‰æ•ˆåœ°æ§åˆ¶å¤§æ–‡ä»¶ä¸Šä¼ çš„å¹¶å‘æ•°é‡ï¼Œæ—¢ä¿è¯äº†ä¸Šä¼ æ•ˆç‡ï¼Œåˆé¿å…äº†èµ„æºè¿‡åº¦å ç”¨çš„é—®é¢˜ã€‚

## 7. æ‹“å±•ç‰ˆæœ¬

```typescript
/**
 * ä»»åŠ¡è°ƒåº¦å™¨ - æ”¯æŒå¹¶å‘æ§åˆ¶çš„å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—
 */
class TaskScheduler {
  private tasks: Array<() => Promise<any>> = [];
  private runningCount: number = 0;
  private maxRunning: number;
  private isDestroyed: boolean = false;

  /**
   * åˆ›å»ºä»»åŠ¡è°ƒåº¦å™¨å®ä¾‹
   * @param maxRunning æœ€å¤§å¹¶å‘æ•°ï¼Œé»˜è®¤ä¸ºæ— é™åˆ¶
   */
  constructor(maxRunning: number = Infinity) {
    if (typeof maxRunning !== "number" || maxRunning < 0) {
      throw new Error("maxRunning must be a non-negative number");
    }
    this.maxRunning = maxRunning === 0 ? Infinity : maxRunning;
  }

  /**
   * æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
   */
  private run(): void {
    // è¾¹ç•Œåˆ¤æ–­ï¼šè°ƒåº¦å™¨å·²é”€æ¯
    if (this.isDestroyed) {
      return;
    }

    // è¾¹ç•Œåˆ¤æ–­ï¼šå·²è¾¾åˆ°æœ€å¤§å¹¶å‘æ•°
    if (this.runningCount >= this.maxRunning) {
      return;
    }

    // è¾¹ç•Œåˆ¤æ–­ï¼šä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º
    if (this.tasks.length === 0) {
      return;
    }

    this.runningCount++;
    const task = this.tasks.shift();

    // å®‰å…¨æ£€æŸ¥ï¼šç¡®ä¿ä»»åŠ¡å­˜åœ¨
    if (!task) {
      this.runningCount--;
      return;
    }

    // æ‰§è¡Œä»»åŠ¡å¹¶å¤„ç†å®Œæˆåçš„æ¸…ç†
    task()
      .finally(() => {
        this.runningCount--;
        // é€’å½’æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡
        this.run();
      })
      .catch(error => {
        // è®°å½•æœªå¤„ç†çš„é”™è¯¯ï¼ˆå¯é€‰ï¼šæ·»åŠ æ—¥å¿—ç³»ç»Ÿï¼‰
        console.warn("Unhandled task error:", error);
      });
  }

  /**
   * æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—
   * @param task è¿”å›Promiseçš„å¼‚æ­¥ä»»åŠ¡å‡½æ•°
   * @returns Promiseï¼Œè§£æä¸ºä»»åŠ¡æ‰§è¡Œç»“æœ
   */
  addTask<T>(task: () => Promise<T>): Promise<T> {
    // è¾¹ç•Œåˆ¤æ–­ï¼šè°ƒåº¦å™¨å·²é”€æ¯
    if (this.isDestroyed) {
      return Promise.reject(new Error("TaskScheduler has been destroyed"));
    }

    // è¾¹ç•Œåˆ¤æ–­ï¼šä»»åŠ¡å‚æ•°éªŒè¯
    if (typeof task !== "function") {
      return Promise.reject(new Error("Task must be a function"));
    }

    return new Promise<T>((resolve, reject) => {
      // åŒ…è£…ä»»åŠ¡ä»¥å¤„ç†ç»“æœä¼ é€’
      const wrappedTask = async (): Promise<void> => {
        try {
          const result = await task();
          resolve(result);
        } catch (error) {
          reject(error);
        }
      };

      this.tasks.push(wrappedTask);
      this.run();
    });
  }

  /**
   * è·å–å½“å‰çŠ¶æ€ä¿¡æ¯
   */
  getStatus(): {
    pendingTasks: number;
    runningTasks: number;
    maxRunning: number;
    isDestroyed: boolean;
  } {
    return {
      pendingTasks: this.tasks.length,
      runningTasks: this.runningCount,
      maxRunning: this.maxRunning,
      isDestroyed: this.isDestroyed,
    };
  }

  /**
   * æ›´æ–°æœ€å¤§å¹¶å‘æ•°
   * @param maxRunning æ–°çš„æœ€å¤§å¹¶å‘æ•°
   */
  setMaxRunning(maxRunning: number): void {
    if (typeof maxRunning !== "number" || maxRunning < 0) {
      throw new Error("maxRunning must be a non-negative number");
    }

    this.maxRunning = maxRunning === 0 ? Infinity : maxRunning;

    // å¦‚æœæ–°çš„å¹¶å‘æ•°æ›´å¤§ï¼Œå°è¯•æ‰§è¡Œæ›´å¤šä»»åŠ¡
    if (maxRunning > this.runningCount) {
      this.run();
    }
  }

  /**
   * æ¸…ç©ºå¾…æ‰§è¡Œçš„ä»»åŠ¡é˜Ÿåˆ—
   * @param rejectPending æ˜¯å¦æ‹’ç»å¾…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œé»˜è®¤ä¸ºtrue
   */
  clearPendingTasks(rejectPending: boolean = true): void {
    if (rejectPending) {
      // è¿™é‡Œéœ€è¦æ›´å¤æ‚çš„å®ç°æ¥æ‹’ç»å¾…æ‰§è¡Œçš„Promise
      // ç®€åŒ–ç‰ˆæœ¬ï¼šç›´æ¥æ¸…ç©ºé˜Ÿåˆ—
      this.tasks.length = 0;
    } else {
      this.tasks.length = 0;
    }
  }

  /**
   * ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
   * @param timeout è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼Œå¯é€‰
   */
  async waitForCompletion(timeout?: number): Promise<void> {
    return new Promise((resolve, reject) => {
      let timeoutId: ReturnType<typeof setTimeout> | undefined;

      if (timeout) {
        timeoutId = setTimeout(() => {
          reject(new Error(`Timeout after ${timeout}ms`));
        }, timeout);
      }

      const checkCompletion = () => {
        if (this.tasks.length === 0 && this.runningCount === 0) {
          if (timeoutId) clearTimeout(timeoutId);
          resolve();
        } else {
          setTimeout(checkCompletion, 10);
        }
      };

      checkCompletion();
    });
  }

  /**
   * é”€æ¯è°ƒåº¦å™¨ï¼Œæ¸…ç†èµ„æº
   */
  destroy(): void {
    this.isDestroyed = true;
    this.clearPendingTasks(true);
  }
}
```

## 8. æ‹“å±•ç‰ˆæœ¬ä½¿ç”¨ç¤ºä¾‹

```typescript
// è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºå»¶è¿ŸPromise
function delay(ms: number): Promise<void> {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºå¯èƒ½å¤±è´¥çš„ä»»åŠ¡
function createTask(value: any, shouldFail: boolean = false, delayMs: number = 100): () => Promise<any> {
  return async () => {
    await delay(delayMs);
    if (shouldFail) {
      throw new Error(`Task failed with value: ${value}`);
    }
    return value;
  };
}

// è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºè®¡æ•°å™¨ä»»åŠ¡
let taskCounter = 0;
function createCounterTask(delayMs: number = 50): () => Promise<number> {
  return async () => {
    await delay(delayMs);
    return ++taskCounter;
  };
}

// é‡ç½®è®¡æ•°å™¨
function resetCounter() {
  taskCounter = 0;
}

/**
 * åŸºç¡€åŠŸèƒ½æµ‹è¯•
 */
async function testBasicFunctionality() {
  console.log("\n=== åŸºç¡€åŠŸèƒ½æµ‹è¯• ===");

  // æµ‹è¯•1ï¼šåŸºæœ¬ä»»åŠ¡æ‰§è¡Œ
  console.log("æµ‹è¯•1: åŸºæœ¬ä»»åŠ¡æ‰§è¡Œ");
  const scheduler = new TaskScheduler();
  const result = await scheduler.addTask(createTask("hello"));
  console.log("ç»“æœ:", result); // åº”è¯¥è¾“å‡º: hello

  // æµ‹è¯•2ï¼šå¤šä¸ªä»»åŠ¡é¡ºåºæ‰§è¡Œ
  console.log("\næµ‹è¯•2: å¤šä¸ªä»»åŠ¡æ‰§è¡Œ");
  resetCounter();
  const promises = [
    scheduler.addTask(createCounterTask()),
    scheduler.addTask(createCounterTask()),
    scheduler.addTask(createCounterTask()),
  ];
  const results = await Promise.all(promises);
  console.log("æ‰§è¡Œé¡ºåº:", results); // åº”è¯¥æ˜¯ [1, 2, 3] æˆ–å…¶ä»–é¡ºåº

  scheduler.destroy();
}

/**
 * å¹¶å‘æ§åˆ¶æµ‹è¯•
 */
async function testConcurrencyControl() {
  console.log("\n=== å¹¶å‘æ§åˆ¶æµ‹è¯• ===");

  // æµ‹è¯•3ï¼šé™åˆ¶å¹¶å‘æ•°
  console.log("æµ‹è¯•3: é™åˆ¶å¹¶å‘æ•°ä¸º2");
  const scheduler = new TaskScheduler(2);
  resetCounter();

  const startTime = Date.now();
  const promises = [
    scheduler.addTask(createCounterTask(200)), // 200ms
    scheduler.addTask(createCounterTask(200)), // 200ms
    scheduler.addTask(createCounterTask(200)), // 200ms
    scheduler.addTask(createCounterTask(200)), // 200ms
  ];

  const results = await Promise.all(promises);
  const endTime = Date.now();
  const duration = endTime - startTime;

  console.log("æ‰§è¡Œç»“æœ:", results);
  console.log("æ‰§è¡Œæ—¶é—´:", duration, "ms");
  console.log("é¢„æœŸæ—¶é—´: ~400ms (2æ‰¹æ¬¡å¹¶å‘)");

  // æµ‹è¯•4ï¼šåŠ¨æ€è°ƒæ•´å¹¶å‘æ•°
  console.log("\næµ‹è¯•4: åŠ¨æ€è°ƒæ•´å¹¶å‘æ•°");
  scheduler.setMaxRunning(1);
  console.log("è°ƒæ•´åçŠ¶æ€:", scheduler.getStatus());

  scheduler.destroy();
}

/**
 * ä¸»æµ‹è¯•å‡½æ•°
 */
async function runAllTests() {
  console.log("å¼€å§‹ TaskSchedulerClass å…¨é¢æµ‹è¯•...");

  try {
    await testBasicFunctionality();
    await testConcurrencyControl();
    // æ·»åŠ æ›´å¤šæµ‹è¯•ç”¨ä¾‹ å¤ªé•¿å†™ä¸ä¸‹äº†ï¼Œä¼°è®¡ä½ ä»¬ä¹Ÿä¸çœ‹ã€‚ã€‚ã€‚
    console.log("\nğŸ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼");
  } catch (error) {
    console.error("âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:", error);
  }
}
runAllTests()
```
